<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI-Assisted Development - Pilot KPIs</title>
  <!-- Chart.js and annotation plugin inlined by refresh.py -->
  <script>
    // __CHARTJS_PLACEHOLDER__
  </script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "DM Sans", Inter, system-ui, -apple-system, sans-serif;
      background: #ffffff;
      color: #1a1a1a;
      padding: 1.5rem 2rem 2rem;
      font-size: 14px;
    }
    .header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1rem 1.5rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e5e7eb;
    }
    .header h1 {
      font-size: 1.25rem;
      font-weight: 600;
      flex: 1 1 100%;
    }
    .header-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem 1.5rem;
      font-size: 0.75rem;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .header-meta span { white-space: nowrap; }
    .kpi-row {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    @media (max-width: 1200px) {
      .kpi-row { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px) {
      .kpi-row { grid-template-columns: 1fr; }
    }
    .kpi-card {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1rem;
    }
    .kpi-card.pilot-good { border-left: 3px solid #15803d; }
    .kpi-card.neutral { border-left: 3px solid #6b7280; }
    .kpi-card h3 {
      font-size: 0.625rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #6b7280;
      margin-bottom: 0.5rem;
    }
    .kpi-card .value { font-size: 1.5rem; font-weight: 600; }
    .kpi-card .detail { font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem; }
    .kpi-card .vs-baseline { font-size: 0.75rem; color: #15803d; margin-top: 0.25rem; }
    .chart-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }
    .chart-card h2 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .chart-card .subtitle {
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 1rem;
    }
    .chart-container { position: relative; height: 280px; }
    canvas { max-height: 280px; }
    .lower-badge { font-size: 0.7rem; color: #15803d; font-weight: 600; margin-bottom: 0.5rem; }
    .survey-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-top: 1.5rem;
    }
    @media (max-width: 900px) {
      .survey-row { grid-template-columns: 1fr; }
    }
    .survey-panel {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1rem;
    }
    .survey-panel h4 { font-size: 0.75rem; text-transform: uppercase; color: #6b7280; margin-bottom: 0.5rem; }
    .survey-panel .stat { font-size: 0.875rem; font-weight: 600; color: #1a1a1a; margin-bottom: 0.25rem; }
    .survey-panel .quote { font-size: 0.875rem; font-style: italic; color: #4b5563; }
    .three-col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
    @media (max-width: 1000px) { .three-col { grid-template-columns: 1fr; } }
    .heatmap-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; font-size: 0.7rem; }
    .heatmap-cell { padding: 0.5rem; text-align: center; border-radius: 4px; }
    .heatmap-cell.pilot-win { background: rgba(21,128,61,0.2); }
    .heatmap-cell.np-win { background: rgba(217,119,6,0.2); }
    .methodology { margin-top: 1.5rem; padding: 1rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; font-size: 0.8rem; color: #4b5563; }
    .methodology h3 { font-size: 0.75rem; text-transform: uppercase; color: #6b7280; margin-bottom: 0.5rem; }
  </style>
</head>
<body>
  <div class="header" id="header"></div>
  <div class="kpi-row" id="kpi-cards"></div>
  <div class="chart-card">
    <h2>Productivity</h2>
    <p class="subtitle">Tickets per FTE-day. Lines = 4-week rolling avg. Dots = raw weekly. Weeks with &lt;5 tickets dimmed.</p>
    <div class="chart-container">
      <canvas id="chart-productivity"></canvas>
    </div>
  </div>
  <div class="chart-card">
    <h2>Quality - QA Churn Rate</h2>
    <p class="subtitle">% of tickets requiring QA rework.</p>
    <p class="lower-badge">LOWER IS BETTER</p>
    <div class="chart-container">
      <canvas id="chart-qa"></canvas>
    </div>
    <div id="qa-period-avg" style="margin-top:0.5rem;font-size:0.8rem;color:#6b7280;"></div>
  </div>
  <div class="three-col">
    <div class="chart-card">
      <h2>Availability</h2>
      <p class="subtitle">Active pilot devs per week vs. total output.</p>
      <div class="chart-container"><canvas id="chart-availability"></canvas></div>
    </div>
    <div class="chart-card">
      <h2>Productivity by Size × Complexity</h2>
      <p class="subtitle">Pilot advantage: green = pilot faster, red = non-pilot faster.</p>
      <div id="heatmap-container" style="min-height:160px;"></div>
    </div>
    <div class="chart-card">
      <h2>Cumulative Output</h2>
      <p class="subtitle">Running total since pilot start.</p>
      <div id="cumulative-label" style="font-size:0.75rem;color:#6b7280;margin-bottom:0.5rem;"></div>
      <div class="chart-container"><canvas id="chart-cumulative"></canvas></div>
    </div>
  </div>
  <div class="chart-card">
    <h2>Experience - Developer Survey</h2>
    <p class="subtitle">Key findings across productivity, quality, and experience.</p>
    <div class="survey-row" id="survey-panels"></div>
  </div>
  <div class="methodology" id="methodology"></div>

  <script>
    // __DATA_PLACEHOLDER__

    const D = window.__DASHBOARD_DATA__ || {};
    const meta = D.meta || {};
    const kpi = D.kpiCards || {};
    const prod = D.productivity || {};
    const qa = D.qaChurn || {};
    const survey = D.survey || {};

    // Header
    document.getElementById("header").innerHTML = `
      <h1>${meta.title || "AI-Assisted Development - Pilot KPIs"}</h1>
      <div class="header-meta">
        <span>DATA ${meta.dataRangeStart || "—"} to ${meta.dataRangeEnd || "—"}</span>
        <span>PILOT START ${meta.pilotStart || "—"}</span>
        <span>PILOT ${meta.pilotCount ?? 6} devs</span>
        <span>NON-PILOT ${meta.nonPilotCount ?? 9} devs</span>
        <span>VALID WEEKS ${meta.validWeeks ?? 0}</span>
        <span>REFRESHED ${meta.refreshedAt || ""}</span>
      </div>
    `;

    // KPI Cards
    const pProd = kpi.pilotProductivity || {};
    const pMult = kpi.productivityMultiple || {};
    const pQa = kpi.pilotQaChurn || {};
    const aiShare = kpi.aiOutputShare || {};
    const avail = kpi.availability || {};
    document.getElementById("kpi-cards").innerHTML = `
      <div class="kpi-card pilot-good">
        <h3>Pilot Productivity</h3>
        <div class="value">${pProd.value ?? "—"}</div>
        <div class="vs-baseline">${pProd.vsBaseline ? pProd.vsBaseline + " vs baseline" : ""}</div>
        <div class="detail">${pProd.unit || "tickets / FTE-day"}</div>
      </div>
      <div class="kpi-card neutral">
        <h3>Productivity Multiple</h3>
        <div class="value">${pMult.value ?? "—"}</div>
        <div class="detail">Pilot vs Non-Pilot</div>
        <div class="detail">Non-pilot: ${pMult.nonPilotValue ?? "—"}</div>
      </div>
      <div class="kpi-card pilot-good">
        <h3>Pilot QA Churn</h3>
        <div class="value">${pQa.value ?? "—"}</div>
        <div class="vs-baseline">${pQa.vsBaseline || ""}</div>
        <div class="detail">Non-pilot: ${pQa.nonPilotValue ?? "—"}</div>
      </div>
      <div class="kpi-card neutral">
        <h3>AI Output Share</h3>
        <div class="value">${aiShare.value ?? "—"}</div>
        <div class="detail">${aiShare.tickets || ""}</div>
        <div class="detail">${aiShare.devs || ""}</div>
      </div>
      <div class="kpi-card neutral">
        <h3>Availability</h3>
        <div class="value">${avail.value ?? "—"}</div>
        <div class="detail">${avail.detail || ""}</div>
        <div class="detail">${avail.devCount ?? 0} pilot developers</div>
      </div>
    `;

    // QA Period Avg
    document.getElementById("qa-period-avg").textContent =
      `PILOT PERIOD AVG ${qa.pilotPeriodAvg ?? "—"}% vs ${qa.nonPilotPeriodAvg ?? "—"}%`;

    // Survey panels (with stat + quote)
    const prodS = survey.productivity || {};
    const qualS = survey.quality || {};
    const expS = survey.experience || {};
    document.getElementById("survey-panels").innerHTML = `
      <div class="survey-panel">
        <h4>PRODUCTIVITY</h4>
        <div class="stat">${prodS.stat || "—"}</div>
        <div class="quote">${prodS.quote || ""}</div>
      </div>
      <div class="survey-panel">
        <h4>QUALITY</h4>
        <div class="stat">${qualS.stat || "—"}</div>
        <div class="quote">${qualS.quote || ""}</div>
      </div>
      <div class="survey-panel">
        <h4>OVERALL EXPERIENCE</h4>
        <div class="stat">${expS.stat || "—"}</div>
        <div class="quote">${expS.quote || ""}</div>
      </div>
    `;

    // Methodology
    document.getElementById("methodology").innerHTML = `
      <h3>Methodology</h3>
      <p>${D.methodology || "—"}</p>
    `;

    // Heatmap
    const hm = D.heatmap || {};
    const cells = hm.cells || [];
    const cols = hm.cols || [];
    const rows = hm.rows || [];
    if (cells.length && cols.length && rows.length) {
      let html = '<table class="heatmap-grid" style="width:100%;border-collapse:collapse"><tr><th></th>';
      cols.forEach(c => { html += `<th style="font-size:0.65rem;padding:4px">${c}</th>`; });
      html += '</tr>';
      for (let r = 0; r < rows.length; r++) {
        html += `<tr><td style="font-size:0.65rem;padding:4px;text-align:right">${rows[r]}</td>`;
        for (let c = 0; c < cols.length; c++) {
          const cell = cells[r * cols.length + c] || {};
          const cls = (cell.pctDiff || 0) > 0 ? 'pilot-win' : (cell.pctDiff || 0) < 0 ? 'np-win' : '';
          const pct = cell.pctDiff > 0 ? '+' + cell.pctDiff + '%' : cell.pctDiff + '%';
          html += `<td class="heatmap-cell ${cls}" style="padding:4px">${pct}<br>${cell.label || ''}</td>`;
        }
        html += '</tr>';
      }
      html += '</table>';
      document.getElementById("heatmap-container").innerHTML = html;
    }

    // Cumulative label
    const aiVal = kpi.aiOutputShare?.value || '';
    document.getElementById("cumulative-label").textContent = aiVal ? `${aiVal} OF DEVS – OUTPUT` : '';

    // Charts
    const annotationPlugin = window["chartjs-plugin-annotation"];
    if (annotationPlugin) Chart.register(annotationPlugin);

    const weeks = prod.weeks || [];
    const baseline = prod.baseline ?? 0.169;

    if (weeks.length > 0) {
      const pilotRoll = prod.pilot?.rolling || [];
      const pilotRaw = prod.pilot?.raw || [];
      const pilotDim = prod.pilot?.lowConfidence || [];
      const holidayGap = prod.pilot?.holidayGap || [];
      const npRoll = prod.nonPilot?.rolling || [];
      const npRaw = prod.nonPilot?.raw || [];
      const toNull = (arr, gap) => arr.map((v, i) => (gap[i] ? null : (Number.isFinite(v) ? v : null)));
      const pilotRollData = toNull(pilotRoll, holidayGap);
      const npRollData = toNull(npRoll, holidayGap);

      new Chart(document.getElementById("chart-productivity"), {
        type: "line",
        data: {
          labels: weeks,
          datasets: [
            {
              label: `Pilot (n = ${meta.pilotCount ?? 6})`,
              data: pilotRollData,
              spanGaps: false,
              borderColor: "#15803d",
              backgroundColor: "transparent",
              borderWidth: 2,
              fill: false,
              tension: 0.2,
              pointRadius: pilotRaw.map((_, i) => (pilotDim[i] || holidayGap[i] ? 3 : 6)),
              pointBackgroundColor: pilotRaw.map((_, i) => (pilotDim[i] || holidayGap[i] ? "rgba(21,128,61,0.4)" : "#15803d")),
              pointHoverRadius: 8,
            },
            {
              label: `Non-Pilot (n = ${meta.nonPilotCount ?? 9})`,
              data: npRollData,
              spanGaps: false,
              borderColor: "#d97706",
              backgroundColor: "transparent",
              borderWidth: 2,
              borderDash: [6, 4],
              fill: false,
              tension: 0.2,
              pointRadius: npRaw.map((_, i) => (pilotDim[i] || holidayGap[i] ? 2 : 4)),
              pointBackgroundColor: npRaw.map((_, i) => (pilotDim[i] || holidayGap[i] ? "rgba(217,119,6,0.4)" : "#d97706")),
            },
            {
              label: "Baseline",
              data: weeks.map(() => baseline),
              borderColor: "rgba(107,114,128,0.7)",
              borderWidth: 1,
              borderDash: [4, 4],
              fill: false,
              pointRadius: 0,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "bottom" },
            annotation: {
              annotations: {
                last4wk: {
                  type: "label",
                  xValue: weeks.length - 1,
                  yValue: Math.max(...(pilotRoll.concat(npRoll).filter(Number.isFinite)) || 0.4),
                  content: `PILOT VS NON-PILOT (LAST 4WK) ${prod.last4wkComparison || ""}`,
                  color: "#d97706",
                  font: { size: 10 },
                },
              },
            },
          },
          scales: {
            x: { ticks: { maxRotation: 45 }, grid: { display: false } },
            y: {
              title: { display: true, text: "Tickets / FTE-Day" },
              min: 0,
              max: 0.7,
              ticks: { stepSize: 0.1 },
            },
          },
        },
      });
    }

    // QA Churn chart (holiday gap)
    const qaPilot = qa.pilot || [];
    const qaNonPilot = qa.nonPilot || [];
    const qaPilotData = holidayGap.length ? qaPilot.map((v, i) => holidayGap[i] ? null : v) : qaPilot;
    const qaNonPilotData = holidayGap.length ? qaNonPilot.map((v, i) => holidayGap[i] ? null : v) : qaNonPilot;
    if (weeks.length > 0 && (qaPilot.length || qaNonPilot.length)) {
      new Chart(document.getElementById("chart-qa"), {
        type: "line",
        data: {
          labels: weeks,
          datasets: [
            { label: "Pilot", data: qaPilotData, spanGaps: false, borderColor: "#15803d", backgroundColor: "transparent", borderWidth: 2, fill: false, tension: 0.2 },
            { label: "Non-Pilot", data: qaNonPilotData, spanGaps: false, borderColor: "#d97706", backgroundColor: "transparent", borderWidth: 2, borderDash: [6, 4], fill: false, tension: 0.2 },
          ],
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: "bottom" } }, scales: { x: { ticks: { maxRotation: 45 }, grid: { display: false } }, y: { title: { display: true, text: "%" }, min: 0, max: 50, ticks: { stepSize: 5 } } } },
      });
    }

    // Availability chart (bar + line)
    const av = D.availability || {};
    const avWeeks = av.weeks || weeks;
    const avDevs = av.activePilotDevs || [];
    const avTickets = av.totalTickets || [];
    if (avWeeks.length && (avDevs.length || avTickets.length)) {
      new Chart(document.getElementById("chart-availability"), {
        type: "bar",
        data: {
          labels: avWeeks,
          datasets: [
            { label: "Active Pilot Devs", data: avDevs, type: "bar", backgroundColor: "rgba(21,128,61,0.6)", borderColor: "#15803d", borderWidth: 1, yAxisID: "y" },
            { label: "Total Tickets", data: avTickets, type: "line", borderColor: "#d97706", backgroundColor: "transparent", borderWidth: 2, borderDash: [4, 4], fill: false, tension: 0.2, yAxisID: "y1", pointRadius: 3 },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: "bottom" } },
          scales: {
            x: { ticks: { maxRotation: 45, maxTicksLimit: 12 }, grid: { display: false } },
            y: { type: "linear", position: "left", min: 0, max: 7, title: { display: true, text: "Devs" } },
            y1: { type: "linear", position: "right", min: 0, grid: { drawOnChartArea: false }, title: { display: true, text: "Tickets" } },
          },
        },
      });
    }

    // Cumulative Output chart
    const cum = D.cumulativeOutput || {};
    const cumWeeks = cum.weeks || weeks;
    const cumPilot = cum.pilot || [];
    const cumNonPilot = cum.nonPilot || [];
    if (cumWeeks.length && (cumPilot.length || cumNonPilot.length)) {
      new Chart(document.getElementById("chart-cumulative"), {
        type: "line",
        data: {
          labels: cumWeeks,
          datasets: [
            { label: "Pilot", data: cumPilot, borderColor: "#15803d", backgroundColor: "transparent", borderWidth: 2, fill: false, tension: 0.1 },
            { label: "Non-Pilot", data: cumNonPilot, borderColor: "#d97706", backgroundColor: "transparent", borderWidth: 2, borderDash: [6, 4], fill: false, tension: 0.1 },
          ],
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: "bottom" } }, scales: { x: { ticks: { maxRotation: 45, maxTicksLimit: 12 }, grid: { display: false } }, y: { min: 0 } } },
      });
    }
  </script>
</body>
</html>
